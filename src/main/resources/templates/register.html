<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narsil - Create Account</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="page-border auth-shell">
<div class="bg-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
</div>

<div class="glass-card auth-card wide" style="position:relative; z-index:1;">
    <div class="brand-mark">
        <span style="font-family:var(--font-display); font-weight:900; letter-spacing:1px; color:rgba(234,255,255,0.96);">N</span>
    </div>

    <h1 class="brand-title">JOIN NARSIL CORE</h1>
    <p class="brand-sub">가입 전에 이메일 인증을 완료해야 회원가입이 가능합니다.</p>

    <div id="errorMessage" class="error-msg"></div>
    <div id="successMessage" class="notice" style="display:none;"></div>

    <form id="registerForm">
        <div style="margin-bottom:14px;">
            <label class="form-label">Username</label>
            <input type="text" class="narsil-input" id="username" required minlength="3" placeholder="unique username">
        </div>

        <div style="margin-bottom:14px;">
            <label class="form-label">Password</label>
            <input type="password" class="narsil-input" id="password" required minlength="4" placeholder="at least 4 characters">
        </div>

        <div style="margin-bottom:14px;">
            <label class="form-label">Display Name</label>
            <input type="text" class="narsil-input" id="displayName" required placeholder="name shown in chats">
        </div>

        <div style="margin-bottom:14px;">
            <label class="form-label">Email (인증 필수)</label>
            <div style="display:grid; grid-template-columns: 1fr 160px; gap: 10px;">
                <input type="email" class="narsil-input" id="email" required placeholder="you@company.com">
                <button type="button" id="sendCodeBtn" class="btn-ghost" style="font-weight:900;">인증 메일 전송</button>
            </div>
        </div>

        <div style="margin-bottom:10px;">
            <label class="form-label">Email Code</label>
            <div style="display:grid; grid-template-columns: 1fr 160px; gap: 10px;">
                <input type="text" class="narsil-input" id="emailCode" maxlength="6" placeholder="메일로 받은 6자리 인증번호">
                <button type="button" id="verifyCodeBtn" class="btn-narsil btn-narsil-sm" style="width:100%;">인증번호 확인</button>
            </div>
            <div id="verifyState" style="margin-top:8px; font-size:13px; color:rgba(255,236,190,0.95);">이메일 인증 필요</div>
        </div>

        <button type="submit" class="btn-narsil" id="registerBtn" style="width:100%; margin-top:10px;">Create Account</button>
    </form>

    <div class="auth-footer">
        이미 계정이 있나요? <a th:href="@{/auth/login}">Sign In</a>
    </div>
</div>

<div class="brand-footer">Narsil Messenger</div>

<script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
<script>
    var emailVerified = false;

    function showError(message) {
        $('#successMessage').hide();
        $('#errorMessage').text(message).addClass('show');
    }

    function showSuccess(message) {
        $('#errorMessage').removeClass('show');
        $('#successMessage').text(message).show();
    }

    $('#sendCodeBtn').on('click', function() {
        var email = $('#email').val().trim();
        if (!email) {
            showError('이메일을 입력해 주세요.');
            return;
        }

        var btn = $(this);
        btn.prop('disabled', true).text('전송 중...');

        $.ajax({
            url: '/api/auth/email/send',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ email: email }),
            success: function(res) {
                emailVerified = false;
                if (res.data && res.data.debugCode) {
                    $('#emailCode').val(res.data.debugCode);
                    $('#verifyState').css('color', 'rgba(255,236,190,0.95)').text('인증번호가 자동 입력되었습니다. 인증번호 확인을 눌러주세요.');
                    showSuccess('인증번호가 발급되었습니다. 인증번호 확인을 눌러주세요.');
                } else {
                    $('#verifyState').css('color', 'rgba(255,236,190,0.95)').text('메일로 받은 인증번호를 입력하고 인증번호 확인을 눌러주세요.');
                    showSuccess('인증 메일을 전송했습니다. 메일로 받은 6자리 코드를 입력해 주세요.');
                }
            },
            error: function(xhr) {
                showError(xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : '인증 메일 전송에 실패했습니다.');
            },
            complete: function() {
                btn.prop('disabled', false).text('인증 메일 전송');
            }
        });
    });

    $('#verifyCodeBtn').on('click', function() {
        var email = $('#email').val().trim();
        var code = $('#emailCode').val().trim();

        if (!email || !code) {
            showError('이메일과 인증 코드를 모두 입력해 주세요.');
            return;
        }

        var btn = $(this);
        btn.prop('disabled', true).text('확인 중...');

        $.ajax({
            url: '/api/auth/email/verify',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ email: email, code: code }),
            success: function() {
                emailVerified = true;
                $('#verifyState').css('color', 'rgba(185,255,220,0.96)').text('이메일 인증 완료');
                showSuccess('이메일 인증이 완료되었습니다.');
            },
            error: function(xhr) {
                emailVerified = false;
                $('#verifyState').css('color', 'rgba(255,236,190,0.95)').text('이메일 인증 필요');
                showError(xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : '인증번호 확인에 실패했습니다.');
            },
            complete: function() {
                btn.prop('disabled', false).text('인증번호 확인');
            }
        });
    });

    $('#email').on('input', function() {
        emailVerified = false;
        $('#verifyState').css('color', 'rgba(255,236,190,0.95)').text('이메일 인증 필요');
    });

    $('#registerForm').on('submit', function(e) {
        e.preventDefault();

        if (!emailVerified) {
            showError('회원가입 전에 이메일 인증을 완료해 주세요.');
            return;
        }

        var btn = $('#registerBtn');
        btn.prop('disabled', true).text('Creating account...');

        $.ajax({
            url: '/api/auth/register',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                username: $('#username').val().trim(),
                password: $('#password').val(),
                displayName: $('#displayName').val().trim(),
                email: $('#email').val().trim()
            }),
            success: function() {
                showSuccess('계정이 생성되었습니다. 로그인 페이지로 이동합니다...');
                setTimeout(function() {
                    window.location.href = '/auth/login';
                }, 1200);
            },
            error: function(xhr) {
                showError(xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : '회원가입에 실패했습니다.');
                btn.prop('disabled', false).text('Create Account');
            }
        });
    });

    $('input').on('input', function() {
        $('#errorMessage').removeClass('show');
    });
</script>
</body>
</html>
