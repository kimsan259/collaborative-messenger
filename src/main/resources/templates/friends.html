<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narsil - Friends</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="page-border">
    <div class="bg-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- ??삵돩野껊슣???-->
    <nav class="narsil-nav d-flex justify-content-between align-items-center">
        <a href="/chat/rooms" class="nav-brand"><span>Narsil</span></a>
        <div class="d-flex align-items-center gap-8">
            <a th:href="@{/profile}" class="nav-user" style="text-decoration:none;" th:text="${displayName}">User</a>
            <a th:href="@{/chat/rooms}" class="nav-btn">Chat</a>
            <a th:href="@{/worklog}" class="nav-btn">Worklog</a>
            <a th:href="@{/auth/logout}" class="nav-btn">Logout</a>
        </div>
    </nav>

    <div style="position:relative; z-index:1; max-width:700px; margin:0 auto; padding:32px 20px;">
        <div class="mb-4">
            <h2 class="section-title">Friends</h2>
            <p class="section-sub">Manage your connections</p>
            <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
                <button class="btn-ghost" style="font-size:12px; padding:4px 10px;" onclick="refreshFriendData()">Refresh now</button>
            </div>
        </div>

        <!-- ??-->
        <div class="narsil-tabs mb-4" id="tabNav">
            <button class="narsil-tab active" onclick="switchTab('friends', this)">Friends</button>
            <button class="narsil-tab" onclick="switchTab('received', this)" id="receivedTabBtn">
                Received
                <span class="tab-badge" id="receivedCount" style="display:none">0</span>
            </button>
            <button class="narsil-tab" onclick="switchTab('sent', this)">Sent</button>
            <button class="narsil-tab" onclick="switchTab('search', this)">Add Friend</button>
        </div>

        <!-- 燁살뮄??筌뤴뫖以?-->
        <div id="friendsPanel" class="glass-card" style="overflow:hidden;">
            <div id="friendsList"></div>
            <div id="noFriends" class="empty-state" style="display:none">
                <p>No friends yet.</p>
                <p>Search for users to add friends!</p>
            </div>
        </div>

        <!-- 獄쏆룇? ?遺욧퍕 -->
        <div id="receivedPanel" class="glass-card" style="overflow:hidden; display:none;">
            <div id="receivedList"></div>
            <div id="noReceived" class="empty-state" style="display:none">
                <p>No pending requests.</p>
            </div>
        </div>

        <!-- 癰귣?沅??遺욧퍕 -->
        <div id="sentPanel" class="glass-card" style="overflow:hidden; display:none;">
            <div id="sentList"></div>
            <div id="noSent" class="empty-state" style="display:none">
                <p>No sent requests.</p>
            </div>
        </div>

        <!-- 野꺜??-->
        <div id="searchPanel" style="display:none;">
            <div class="d-flex gap-8 mb-3">
                <input type="text" class="narsil-input" id="searchKeyword"
                       placeholder="Search by username or display name">
                <button class="btn-narsil btn-narsil-sm" onclick="searchUsers()" style="white-space:nowrap;">Search</button>
            </div>
            <div class="glass-card" style="overflow:hidden;">
                <div id="searchResults"></div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
    <script th:inline="javascript">
        var currentUserId = [[${userId}]];

        $(document).ready(function() {
            loadFriends();
            loadReceivedRequests();
            loadSentRequests();
            $('#searchKeyword').on('keypress', function(e) { if (e.which === 13) searchUsers(); });
            setInterval(function() {
                loadFriends();
            }, 10000);
        });

        function refreshFriendData() {
            loadFriends();
            loadReceivedRequests();
            loadSentRequests();
        }

        function switchTab(tab, btn) {
            $('.narsil-tab').removeClass('active');
            $(btn).addClass('active');
            $('#friendsPanel, #receivedPanel, #sentPanel, #searchPanel').hide();
            $('#' + tab + 'Panel').show();
        }

        function avatarHtml(profileImage, name) {
            if (profileImage) {
                return '<div class="member-avatar" style="overflow:hidden; padding:0;">' +
                       '<img src="' + profileImage + '" style="width:100%; height:100%; object-fit:cover; border-radius:50%;"></div>';
            }
            var initial = name ? name.charAt(0) : '?';
            return '<div class="member-avatar">' + escapeHtml(initial) + '</div>';
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        function renderItem(name, username, rightHtml, profileImage) {
            return '<div class="narsil-list-item">' +
                   '  <div class="d-flex align-items-center gap-8">' +
                   avatarHtml(profileImage, name) +
                   '    <div><span style="font-weight:600;">' + escapeHtml(name) + '</span>' +
                   '    <span style="color:var(--text-muted); font-size:12px; margin-left:8px;">@' + escapeHtml(username) + '</span>' +
                   '</div>' +
                   '  </div>' +
                   '  <div>' + rightHtml + '</div></div>';
        }

        function loadFriends() {
            $.get('/api/friends', function(r) {
                var list = $('#friendsList'); list.empty();
                if (r.data.length === 0) { $('#noFriends').show(); return; }
                $('#noFriends').hide();
                r.data.forEach(function(f) {
                    list.append(renderItem(f.friendDisplayName, f.friendUsername,
                        '<button class="btn-narsil btn-narsil-sm" style="margin-right:6px;" onclick="viewProfile(' + f.friendId + ')">Profile</button>' +
                        '<button class="btn-ghost btn-ghost-success" style="margin-right:6px;" onclick="openQuickSend(' + f.friendId + ', \'' + escapeHtml(f.friendDisplayName).replace(/'/g, \"&#39;\") + '\')">Quick Send</button>' +
                        '<button class="btn-narsil btn-narsil-sm" style="margin-right:6px;" onclick="startDm(' + f.friendId + ')">Message</button>' +
                        '<button class="btn-ghost btn-ghost-danger" onclick="removeFriend(' + f.friendshipId + ')">Remove</button>',
                        f.friendProfileImage));
                });
            }).fail(function(xhr) {
                console.error('[friends] load friends failed:', xhr.status, xhr.responseText);
            });
        }

        function loadReceivedRequests() {
            $.get('/api/friends/requests/received', function(r) {
                var list = $('#receivedList'); list.empty();
                if (r.data.length === 0) { $('#noReceived').show(); $('#receivedCount').hide(); return; }
                $('#noReceived').hide(); $('#receivedCount').text(r.data.length).show();
                r.data.forEach(function(f) {
                    list.append(renderItem(f.friendDisplayName, f.friendUsername,
                        '<button class="btn-ghost btn-ghost-success" style="margin-right:6px;" onclick="acceptRequest(' + f.friendshipId + ')">Accept</button>' +
                        '<button class="btn-ghost" onclick="rejectRequest(' + f.friendshipId + ')">Decline</button>',
                        f.friendProfileImage));
                });
            }).fail(function(xhr) {
                console.error('[friends] load received requests failed:', xhr.status, xhr.responseText);
            });
        }

        function loadSentRequests() {
            $.get('/api/friends/requests/sent', function(r) {
                var list = $('#sentList'); list.empty();
                if (r.data.length === 0) { $('#noSent').show(); return; }
                $('#noSent').hide();
                r.data.forEach(function(f) {
                    list.append(renderItem(f.friendDisplayName, f.friendUsername,
                        '<span class="badge-narsil badge-amber">Pending</span>',
                        f.friendProfileImage));
                });
            }).fail(function(xhr) {
                console.error('[friends] load sent requests failed:', xhr.status, xhr.responseText);
            });
        }

        function searchUsers() {
            var keyword = $('#searchKeyword').val().trim();
            if (!keyword) return;
            $.get('/api/friends/search?keyword=' + encodeURIComponent(keyword), function(r) {
                var list = $('#searchResults'); list.empty();
                if (r.data.length === 0) {
                    list.append('<div class="empty-state" style="padding:24px;"><p>No results found.</p></div>');
                    return;
                }
                r.data.forEach(function(f) {
                    var btn = '';
                    if (f.status === 'ACCEPTED') btn = '<span class="badge-narsil badge-green">Friend</span>';
                    else if (f.status === 'PENDING' && f.sentByMe) btn = '<span class="badge-narsil badge-amber">Requested</span>';
                    else if (f.status === 'PENDING' && !f.sentByMe) btn = '<button class="btn-ghost btn-ghost-success" onclick="acceptRequest(' + f.friendshipId + ')">Accept</button>';
                    else btn = '<button class="btn-purple" onclick="sendRequest(' + f.friendId + ')">Add Friend</button>';
                    list.append(renderItem(f.friendDisplayName, f.friendUsername, btn, f.friendProfileImage));
                });
            });
        }

        function sendRequest(userId) {
            $.post('/api/friends/request/' + userId, function() {
                searchUsers(); loadSentRequests();
            }).fail(function(xhr) { alert(xhr.responseJSON ? xhr.responseJSON.message : 'Error'); });
        }

        function acceptRequest(friendshipId) {
            $.post('/api/friends/accept/' + friendshipId, function() {
                loadFriends(); loadReceivedRequests(); searchUsers();
            }).fail(function(xhr) { alert(xhr.responseJSON ? xhr.responseJSON.message : 'Error'); });
        }

        function rejectRequest(friendshipId) {
            $.post('/api/friends/reject/' + friendshipId, function() {
                loadReceivedRequests();
            }).fail(function(xhr) { alert(xhr.responseJSON ? xhr.responseJSON.message : 'Error'); });
        }

        function startDm(targetUserId) {
            $.ajax({
                url: '/api/chat/dm/' + targetUserId,
                type: 'POST',
                success: function(r) {
                    window.location.href = '/chat/room/' + r.data.id;
                },
                error: function(xhr) {
                    alert(xhr.responseJSON ? xhr.responseJSON.message : 'Failed to start DM');
                }
            });
        }

        var quickTargetUserId = null;
        function openQuickSend(targetUserId, displayName) {
            quickTargetUserId = targetUserId;
            $('#quickSendTitle').text('Quick Send to ' + displayName);
            $('#quickMessage').val('');
            $('#quickFile').val('');
            var modal = new bootstrap.Modal(document.getElementById('quickSendModal'));
            modal.show();
        }

        function sendQuickMessage() {
            if (!quickTargetUserId) return;
            var text = $('#quickMessage').val().trim();
            var fileInput = document.getElementById('quickFile');
            var file = fileInput.files && fileInput.files.length > 0 ? fileInput.files[0] : null;

            if (!text && !file) {
                alert('筌롫뗄?놅쭪? ?癒?뮉 ???뵬 餓???롪돌????낆젾??뤾쉭??');
                return;
            }

            $.ajax({
                url: '/api/chat/dm/' + quickTargetUserId,
                type: 'POST',
                success: function(dmRes) {
                    var roomId = dmRes.data.id;
                    if (file) {
                        var formData = new FormData();
                        formData.append('file', file);
                        if (text) formData.append('content', text);
                        $.ajax({
                            url: '/api/chat/rooms/' + roomId + '/messages/file',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function() {
                                alert('???뵬 筌롫뗄?놅쭪????袁⑸꽊??됰뮸??덈뼄.');
                                bootstrap.Modal.getInstance(document.getElementById('quickSendModal')).hide();
                            },
                            error: function(xhr) {
                                alert(xhr.responseJSON ? xhr.responseJSON.message : '???뵬 ?袁⑸꽊 ??쎈솭');
                            }
                        });
                        return;
                    }

                    $.ajax({
                        url: '/api/chat/rooms/' + roomId + '/messages',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            chatRoomId: roomId,
                            content: text,
                            messageType: 'TEXT'
                        }),
                        success: function() {
                            alert('筌롫뗄?놅쭪????袁⑸꽊??됰뮸??덈뼄.');
                            bootstrap.Modal.getInstance(document.getElementById('quickSendModal')).hide();
                        },
                        error: function(xhr) {
                            alert(xhr.responseJSON ? xhr.responseJSON.message : '筌롫뗄?놅쭪? ?袁⑸꽊 ??쎈솭');
                        }
                    });
                },
                error: function(xhr) {
                    alert(xhr.responseJSON ? xhr.responseJSON.message : 'DM ??밴쉐 ??쎈솭');
                }
            });
        }

        function removeFriend(friendshipId) {
            if (!confirm('Remove this friend?')) return;
            $.ajax({ url: '/api/friends/' + friendshipId, type: 'DELETE',
                success: function() { loadFriends(); },
                error: function(xhr) { alert(xhr.responseJSON ? xhr.responseJSON.message : 'Error'); }
            });
        }

        function viewProfile(userId) {
            $.get('/api/users/' + userId, function(r) {
                var u = r.data;
                var imgHtml;
                if (u.profileImage) {
                    imgHtml = '<div class="profile-avatar" style="overflow:hidden; padding:0; margin:0 auto 16px;">' +
                              '<img src="' + u.profileImage + '" style="width:100%; height:100%; object-fit:cover; border-radius:50%;"></div>';
                } else {
                    var initial = u.displayName ? u.displayName.charAt(0) : '?';
                    imgHtml = '<div class="profile-avatar" style="margin:0 auto 16px;">' + escapeHtml(initial) + '</div>';
                }
                $('#profileModalBody').html(
                    '<div style="text-align:center; padding:24px 20px;">' +
                    imgHtml +
                    '<div style="font-weight:700; font-size:18px; margin-bottom:4px;">' + escapeHtml(u.displayName) + '</div>' +
                    '<div style="color:var(--text-muted); font-size:13px; margin-bottom:8px;">@' + escapeHtml(u.username) + '</div>' +
                    (u.email ? '<div style="color:var(--text-secondary); font-size:13px;">' + escapeHtml(u.email) + '</div>' : '') +
                    '<span class="badge-narsil badge-purple" style="margin-top:12px; display:inline-block;">' + escapeHtml(u.role) + '</span>' +
                    '</div>'
                );
                var modal = new bootstrap.Modal(document.getElementById('profileModal'));
                modal.show();
            }).fail(function(xhr) {
                alert(xhr.responseJSON ? xhr.responseJSON.message : 'Failed to load profile');
            });
        }
    </script>

    <!-- ?袁⑥쨮??筌뤴뫀??-->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content" style="background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px;">
                <div class="modal-header" style="border-bottom:1px solid var(--border-subtle); padding:16px 20px;">
                    <h5 class="modal-title" style="font-size:15px; font-weight:700;">Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="profileModalBody" style="padding:0;"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="quickSendModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px;">
                <div class="modal-header" style="border-bottom:1px solid var(--border-subtle); padding:16px 20px;">
                    <h5 class="modal-title" id="quickSendTitle" style="font-size:15px; font-weight:700;">Quick Send</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding:16px 20px;">
                    <textarea id="quickMessage" class="narsil-input" style="min-height:110px;" placeholder="筌롫뗄?놅쭪?????낆젾??뤾쉭??></textarea>
                    <div style="height:10px;"></div>
                    <input id="quickFile" type="file" class="form-control" style="background:rgba(255,255,255,0.06); color:var(--text-primary); border:1px solid var(--border-subtle);">
                    <div style="font-size:12px; color:var(--text-muted); margin-top:8px;">??용뮞????곸뵠 ???뵬筌??袁⑸꽊??猷???몃빍??</div>
                </div>
                <div class="modal-footer" style="border-top:1px solid var(--border-subtle); padding:12px 20px;">
                    <button type="button" class="btn-ghost" data-bs-dismiss="modal">?띯뫁??/button>
                    <button type="button" class="btn-narsil btn-narsil-sm" onclick="sendQuickMessage()">?袁⑸꽊</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
